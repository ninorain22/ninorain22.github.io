---
layout: post
title: 精通比特币学习笔记
date: 2018-03-20 14:30:00.000000000 +09:00
---

## 第1章 介绍
---

### 1.1 什么是比特币
比特币是一个分布式的点对点网络系统，因此没有中央服务器，也没有中央控制点。比特币是通过一个名为"挖矿"的过程产生的，挖矿需要在处理比特币交易的同时参与竞赛来解决一个数学问题。

在比特币网络的任何参与者都是潜在的矿工。每隔10分钟，有人能够验证过去10分钟发生的交易，作为回报，将会获得新的比特币。

比特币协议包括了内置算法，该算法可以调节网络中的挖矿能力。矿工必须完成的任务——在比特币网络中成功的记录一个区块交易——的难度是在动态调整的。因此，无论多少人在同时挖矿，通常每10分钟就有人成功。

比特币由这些构成：
+ 一个去中心化的点对点网络(比特币协议)
+ 一个公共的交易账簿(区块链)
+ 一个去中心化的数学和确定的货币发型(分布式挖矿)
+ 一个去中心化的交易验证系统(交易脚本)


### 1.2 比特币发展史


### 1.3 比特币的应用、用户和他们的故事


### 1.4 入门
比特币客户端的三种主要形式是:
+ 完整客户端：或称"全节点"，是存储所有比特币交易的整个交易历史的客户端，管理用户的钱包，并可以在比特币网络上直接开始交易。
+ 轻量级客户端：存储用户的钱包，但需要依赖第三方服务器才能进行比特币交易，才能接入比特币网络。轻量级客户端不保存所有交易的完整副本，因此必须信赖第三方的服务器获取交易确认。
+ 在线客户端：完全依赖于第三方服务器
+ 移动客户端：多种类型均可

#### 1.4.1 快速入门



## 第2章 比特币的原理
---

### 2.1 交易、区块、挖矿和区块链
在比特币中，信任是由比特币系统中不同参与者之间交互来达成的一种自然属性。

#### 2.1.1 比特币概述
比特币系统由用户(用户通过密钥控制钱包)、交易(每一笔交易都会被广播到整个比特币网络)和矿工(通过竞争计算生成在每个节点达成共识的区块链，区块链是一个分布式的公共权威账簿，包含了比特币网络发生的所有交易)组成

#### 2.1.2 买咖啡
从千分之一比特币(一毫比特币)到以百万分之一(一聪比特币)，比特币网络可以处理任意小额交易。


### 2.2 比特币交易
简单来说，交易告知全网：比特币的持有者已授权把比特币转账给其他人，而新持有者能够在此授权，转移给比特币所有权链中的其他人，产生另一笔交易来花掉这些比特币。

交易就像复式记账法账簿中的行，简单来说，每一笔交易包含一个或多个"输入"，输入是针对一个毕业币账号的负债。有一个或多个"输出"，被当成信用点数计入到毕业币账户中。这些输入和输出的总额不需要相等，相反，当输出累加略少于输入量时，两者的差额就代表了一笔隐含的"矿工费"，这也是将交易放进账簿的矿工所收集到的一笔小额支付。

交易是将钱从交易输入移至输出。输入是指钱币的来源，通常是前一笔交易的输出。输出则是通过关联一个密钥的方式将钱赋予一个新的所有者，目的密钥被称为是安全锁(Encumbrance)。这样就给资金强加了一个要求：有签名才能在以后的交易中赎回资金。

#### 2.2.1 常见的交易形式
最常见的交易形式是从一个地址到另一个地址的简单支付，这种交易也常常包含给支付者的"找零"。一般交易是有一个输入和两个输出；
另一种常见的交易形式是集合多个输入到一个输出的模式，这种类似于现实中零钱兑换为一个大额面钞。
另一种比特币账簿中常见的交易形式是将一个输入分配给多个输出，即多个接收者的交易，类似发工资的情形。


### 2.3 交易的构建
钱包应用设置可以在完全离线时建立交易，只有在执行交易时才需要将交易发送到网络。

#### 2.3.1 获取正确的输入
大多数钱包应用维护者一个含有用钱包自己密钥锁定的"未消费交易输出"小型数据库。
 
完整的客户端好友整个区块链中所有交易的所有为消费输出副本，这是的钱包技能拿这些输出构建交易，也能在收到新交易时很快的验证其输入是否正确，但是会占用太大的硬盘空间。
所以大多数钱包使用轻量级的客户端，只保存自己的未消费输出。如果钱包客户端没有某一未消费输出，它可以通过不同的服务器提供的各种API或完整索引节点的JSON PRC API从比特币网络中拿到这一交易信息

```
查找比特币地址所有的未消费输出
$curl
https://blockchain.info/unspent?active=1Ce19081308hdwahd0921

返回
{
    "unspent_outputs: [
        {
            "tx_hash": "186f932131...123daedjwqdjaodw",
            "tx_index": 104810202,
            "tx_output_n": 0,
            "script": "76adwahoidjwoiajdpwaodkpawdjpowadkwpao",
            "value": 10000000,
            "value_hex: "00989680",
            "confirmations": 0
        }
    ]
}
```

通过这个信息。钱包应用就可以创建新的交易将钱转账到新地址


#### 2.3.2 创建交易输出
交易的输出会被创建成为一个包含这笔数额的脚本的形式，只能被引入这个脚本的一个解答后才能兑换。

#### 2.3.3 将交易放到总账簿中
这个被钱包应用创建的交易大小为258字节，包含了金额未来所需要的全部信息。现在，这个交易必须被传送到比特币网络中以成为分布式账簿(区块链)的一部分。

##### 2.3.3.1 交易的传送
比特币网络是由参与比特币客户端联接几个其他比特币客户端组成的P2P网络。比特币网络的目的是将交易和区块传播给所有参与者

##### 2.3.3.2 如何传播
Alice(输入方)的钱包应用可以发送新的交易给其他任意一个已连接到互联网的比特币客户端，她的钱包不必连着Bob(输出方)的比特币钱包。

任何比特币网络节点(其他客户端)收到一个之前从没有见过的有效交易时，会立即转发给联接到自身的其他节点。因此，这个交易迅速的从P2P网络中传播开来，几秒内就能到达大多数节点。

##### 2.3.3.3 Bob的视角
Alice的交易一般在几秒内到达Bob钱包应用里，Bob钱包应用会立即确认Alice的交易是一个收入支付，因为它包含能用Bob的私钥兑换的输出。Bob的钱包应用也能够独立地用之前未消费输入来确认这个交易是正确构建的，并且由于包含足够的交易费会被下一个区块包含进去。这是Bob就可以以一个很小的风险假定这个交易会很快被加到区块且被确认。


### 2.4 比特币挖矿
这个交易在比特币网络上传播开来，但只有被一个成为挖矿的过程验证且加到一个区块中之后，这个交易才会成为这个共享账簿(区块链)的一部分。

挖矿在比特币系统中起着两个作用：
+ 挖矿在构建区块时会创造新的比特币，和一个中央银行印发新的纸币类似，每个区块创造的比特币数量是固定的，随着时间减少
+ 挖矿创建信任


### 2.5 区块中的挖矿交易记录
网络中产生的一笔交易知道成为整个比特币大账簿(区块链)的一部分时才会被确认有效。平均每10分钟，矿工将会自上一个区块以来发生的所有的交易生成一个新的区块。


### 2.6 消费这笔交易



## 第3章 比特币客户端
---
### 3.1 比特币核心：参考实现
bitcoin.org下载中本聪客户端(satoshi client)。

#### 3.1.1 第一次运行比特币核心

#### 3.1.2 从源码编译比特币核心


### 3.2 通过命令行使用比特币核心的JSON-RPC API接口

#### 3.2.1 获得比特币核心客户端状态的信息
```
$ bitcoin-cli getinfo
{
    "vaersion": 90000,
    "protocolversion": 70002,
    "walletversion": 60000,
    "balance": 0.00000000
    "blocks": 286216,
    "timeoffset": -72,
    "connections": 4,
    "proxy": "",
    "difficulty": 2621404453.06461525,
    "testnet": false,
    "keypoololdest": 1374553827,
    "keypoolsize": 101,
    "paytxfee": 0.000000,
    "errors": ""
}
```

#### 3.2.2 钱包设置及加密
在你向前生成密钥和其他命令之前，你应当先用密码加密钱包。
```
// 密码为"foo"
$ bitcoin-cli encryptwallet foo
```

想要解锁钱包，要使用``walletpassphrase``命令
```
// 360: 多久钱包会被再次自动锁定的秒数
$ bitcoin-cli walletpassphrase foo 360
```

#### 3.2.3 钱包备份、纯文本导出及恢复
```
// 备份钱包
$ bitcoin-cli backupwallet wallet.backup
// 重新加载备份文件
$ bitcoin-cli importwallet wallet.backup
// 将钱包转储为可读的文本文件
$ bitcoin-cli dumpwallet wallet.txt
```

#### 3.2.4 钱包地址及接收交易
```
// 获取比特币客户端维护的地址池中的一个地址，可用作公开接收地址或者零钱地址
$ bitcoin-cli getnewaddress
1hvzSofGwT8cjb8JU7nBsCSfEVQX5u9CL
```
现在可以使用这个地址从一个外币钱包向我们的bitcoind钱包发送一笔比特币
我们可以询问bitcoind客户端次地址已经收到的比特币的数额，以及指定该数额要被加到余额中所需要的确认数
```
// 需要0个确认，意味着从另一个比特币钱包发送到本钱包后，不需要确认，数秒后本钱包即可看到比特币
$ bitcoin-cli getreceivedbyaddress
1hvzSofGwT8cjb8JU7nBsCSfEVQX5u9CL 0
0.05000000
```

整个钱包接收到的交易可以用``listtransactions``来展示
```
$ bitcoin-cli listtransactions
[
  {
     "account" : "",
     "address":"1hvzSofGwT8cjb8JU7nBsCSfEVQX5u9CL",
     "category" : "receive",
     "amount" : 0.05000000,
     "confirmations" : 0,
     "txid" :
"9ca8f969bd3ef5ec2a8685660fdbf7a8bd365524c2e1fc66c309ac
bae2c14ae3",
     "time" : 1392660908,
     "timereceived" : 1392660908
  }
]
```

可以使用``getaddressesbyaccount``来列出整个钱包的所有地址
```
$ bitcoin-cli getaddressesbyaccount ""
[
    "1LQoTPYy1TyERbNV4zZbhEmgyfAipC6eqL",
    "17vrg8uwMQUibkvS2ECRX4zpcVJ78iFaZS",
    "1FvRHWhHBBZA8cGRRsGiAeqEzUmjJkJQWR",
    "1NVJK3JsL41BF1KyxrUyJW5XHjunjfp2jz",
    "14MZqqzCxjc99M5ipsQSRfieT7qPZcM7Df",
    "1BhrGvtKFjTAhGdPGbrEwP3xvFjkJBuFCa",
    "15nem8CX91XtQE8B1Hdv97jE8X44H3DQMT",
    "1Q3q6taTsUiv3mMemEuQQJ9sGLEGaSjo81",
    "1HoSiTg8sb16oE6SrmazQEwcGEv8obv9ns",
    "13fE8BGhBvnoy68yZKuWJ2hheYKovSDjqM",
    "1hvzSofGwT8cjb8JU7nBsCSfEVQX5u9CL",
    "1KHUmVfCJteJ21LmRXHSpPoe23rXKifAb2",
    "1LqJZz1D9yHxG4cLkdujnqG5jNNGmPeAMD"
]
```

#### 3.2.5 探索及解码交易
我们将使用``gettransaction``命令探索前面列出的入账交易。我们使用``gettransaction``通过交易哈希值获取一笔交易，交易哈希值出现在前面的txid条目
```
$ bitcoin-cli gettransaction
9ca8f969bd3ef5ec2a8685660fdbf7a8bd365524c2e1fc66c309acbae2c14ae3
{
    "amount" : 0.05000000,
    "confirmations" : 0,
    "txid":"9ca8f969bd3ef5ec2a8685660fdbf7a8bd365524c2e1fc66c309acbae2c14ae3",
    "time" : 1392660908,
    "timereceived" : 1392660908,
    "details" : [
    {
        "account" : "",
        "address":"1hvzSofGwT8cjb8JU7nBsCSfEVQX5u9CL",
        "category" : "receive",
        "amount" : 0.05000000
    }]
}

```
交易ID在交易确认之前并不权威。区块链中找不到交易哈希值并不意味着此笔交易没有进行。这被称作"交易延展性"，因为交易哈希值在区块确认之前是可以更改的。在确认txid之后才是不可变的。

若要得到整个交易代码并且将之解码，使用两个命令:``getrawtransaction``和``decoderawtransaction``。``getrawtransaction``把交易哈希值txid当作一个参数，并且把整个交易以一个原始的十六进制字符串的形式返回，而这也正是交易在比特币网络上存在的心事
```
$ bitcoin-cli getrawtransaction
9ca8f969bd3ef5ec2a8685660fdbf7a8bd365524c2e1fc66c309acbae
2c14ae30100000001d717279515f88e2f56ce4e8a31e2ae3e9f00ba1d
0add648e80c480ea22e0c7d3000000008b483045022100a4ebbeec832
25dedead659bbde7da3d026c8b8e12e61a2df0dd0758e227383b30220
3301768ef878007e9ef7c304f70ffaf1f2c975b192d34c5b9b2ac1bd1
93dfba2014104793ac8a58ea751f9710e39aad2e296cc14daa44fa592
48be58ede65e4c4b884ac5b5b6dede05ba84727e34c8fd3ee1d6929d7
a44b6e111d41cc79e05dbfe5ceaffffffff02404b4c00000000001976
a91407bdb518fa2e6089fd810235cf1100c9c13d1fd288ac1f3129060
00000001976a914107b7086b31518935c8d28703d66d09b3623134388
ac00000000
```

一旦我们接收到的交易以记录在区块中的方式被确认，``gettransaction``命令将返回附加信息，显示包含交易的区块的哈希值(标识符)，包括``blockindex``, ``blocktime``, ``blockhash``等。

#### 3.2.6 探索区块
既然知道了我们的交易在哪个区块中，我们可以使用``getblock``命令，并把区块哈希值作为参数来查询对应的区块
```
$ bitcoin-cli getblock 000000000000000051d2e759c63a26e247f185ecb7926ed7a6624b↵
c31c2a717b true
{
   "hash" : "000000000000000051d2e759c63a26e247f185ecb7926ed7a6624bc31c2a717b",
   "confirmations" : 2,
   "size" : 248758,
   "height" : 286384,
   "version" : 2,
   "merkleroot" : "9891747e37903016c3b77c7a0ef10acf467c530de52d84735bd55538719f9916",
   "tx" : [
       "46e130ab3c67d31d2b2c7f8fbc1ca71604a72e6bc504c8a35f777286
       c6d89bf0",
       "2d5625725b66d6c1da88b80b41e8c07dc5179ae2553361c96b14bcf1
       ce2c3868",
       "923392fc41904894f32d7c127059bed27dbb3cfd550d87b9a2dc0382
       4f249c80",
       "f983739510a0f75837a82bfd9c96cd72090b15fa3928efb9cce95f68
       84203214",
       "190e1b010d5a53161aa0733b953eb29ef1074070658aaa656f933ded
       1a177952",
       "ee791ec8161440262f6e9144d5702f0057cef7e5767bc043879b7c2f
       f3ff5277",
       "4c45449ff56582664abfadeb1907756d9bc90601d32387d9cfd4f1ef
       813b46be",
       "3b031ed886c6d5220b3e3a28e3261727f3b4f0b29de5f93bc2de3e97
       938a8a53",
       "14b533283751e34a8065952fd1cd2c954e3d37aaa69d4b183ac64834
       81e5497d",
       "57b28365adaff61aaf60462e917a7cc9931904258127685c18f136ee
       aebd5d35",
       "8c0cc19fff6b66980f90af39bee20294bc745baf32cd83199aa83a1f
       0cd6ca51",
       "1b408640d54a1409d66ddaf3915a9dc2e8a6227439e8d91d2f74e704
       ba1cdae2",
       "0568f4fad1fdeff4dc70b106b0f0ec7827642c05fe5d2295b9deba4f
       5c5f5168",
       "9194bfe5756c7ec04743341a3605da285752685b9c7eebb594c6ed9e
       c9145f86",
       "765038fc1d444c5d5db9163ba1cc74bba2b4f87dd87985342813bd24
       021b6faf",
       "bff1caa9c20fa4eef33877765ee0a7d599fd1962417871ca63a24864
       76637136",
       "d76aa89083f56fcce4d5bf7fcf20c0406abdac0375a2d3c62007f64a
       a80bed74",
       "e57a4c70f91c8d9ba0ff0a55987ea578affb92daaa59c76820125f31
       a9584dfc",
       "9ca8f969bd3ef5ec2a8685660fdbf7a8bd365524c2e1fc66c309acba
       e2c14ae3",
       #[... many more transactions ...]
   ],
   "time" : 1392660808,
   "nonce" : 3888130470,
   "bits" : "19015f53",
   "difficulty" : 3129573174.52228737,
   "chainwork" : "000000000000000000000000000000000000000000001931d1658fc04879e466",
   "previousblockhash" : "0000000000000000177e61d5f6ba6b9450e0dade9f39c257b4d48b4941ac77e7",
   "nextblockhash" :"0000000000000001239d2c3bf7f4c68a4ca673e434702a57da8fe0d829a92eb6"
}
```
这个区块包含367条交易，``height``表明这就是整个区块链中的第286384个区块。同样也可以通过``getblockhash``通过区块高度来检索一个区块，需要区块高度作为参数，并且返回那个区块的区块哈希值
```
$ bitcoin-cli getblockhash 0000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f
```

#### 3.2.7 基于UTXO(未话费的交易输出)的建立、签名与提交
比特币的交易是基于花费"输出"上的，即上一笔交易的支出，整个交易在地址之间转移所有权。我们的钱包现在收到了向我们发来的钱(输出)，一旦确定之后，钱就归属于我们了。

首先，我们使用``listunspent``查看我们钱包中所有剩余的从之前交易中已确认的支出
```
$ bitcoin-cli listunspent
[
    {
       "txid" :
       "9ca8f969bd3ef5ec2a8685660fdbf7a8bd365524c2e1fc66c309acbae2c14ae3",
       "vout" : 0,
       "address" : "1hvzSofGwT8cjb8JU7nBsCSfEVQX5u9CL",
       "account" : "",
       "scriptPubKey" : "76a91407bdb518fa2e6089fd810235cf1100c9c13d1fd288ac",
       "amount" : 0.05000000,
       "confirmations" : 7
    }
]
```




