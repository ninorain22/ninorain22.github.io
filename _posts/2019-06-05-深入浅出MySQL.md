## 第二部分 开发篇

### 第7章 表类型
5.5后默认InnoDB

##### 7.2.2 InnoDB

1. 自动增长列
对于InnoDB, 自动增长列必须是索引，如果是组合索引，必须是组合索引的第一项。

2. 外键约束
MySQL支持外键约束的只有InnoDB, 创建外键时，父表必须有对应的索引，子表在创建外键时也会自动创建对应索引

3. 存储方式
InnoDB存储表和索引有以下两种方式
+ 使用共享表空间存储，这种方式创建的表结构保存在.frm文件中，数据和索引保存在`innodb_data_home_dir`和`innodb_data_file_path`定义的表空间中，可以是多个文件。
+ 使用多表空间存储，表结构在.frm文件中，但是每个表的数据和索引单独保存在`.ibd`中。
如果是分区表，则每个分度对应单独的`.ibd`文件，文件名是`表名+分区名`，可以在创建分区的时候指定每个分区的数据文件的位置，以此来将表的IO均匀分布在多个磁盘上。


#### 7.3 如何选择合适的存储引擎
InnoDB：用于事务处理应用程序，对事务的完整性有较高要求，在并发时要求数据一致性，那么可以选择InnoDB, InnoDB除了有效的降低由于更新和删除导致的锁定，
还可以确保事务的完整提交和回滚。

### 第8章 选择合适的数据类型

#### 8.1 CHAR和VARCHAR
CHAR属于固定长度的字符类型，VARCHAR属于可变长度的字符类型

检索时，CHAR列删除了尾部的空格，优点是由于长度固定，所以处理速度快，去诶单是浪费存储空间，程序需要处理尾部空格。

在InnoDB中，建议使用过VARCHAR类型，因为内部的行存储格式并没有区分固定长度和可变长度的列，因此，本质上，使用CHAR的性能不一定要优于使用VARCHAR。
主要的性能因素是数据行使用的存储总量，所以使用占用空间较小的VARCHAR比较好

#### 8.2 TEXT和BLOB
TEXT只能保存字符串，BLOB能用来保存二进制数据，比如图片等。
+ BLOB和TEXT都会引起一些性能问题，特别是执行了大量的删除操作时，会在数据表中留下很大的空洞，以后填入这些空洞的记录在插入的性能上会有影响。
因此，建议定期使用`OPTIMIZE TABLE`功能对这类表进行碎片整理。
+ 可以使用合成的索引来提高大文本字段(BLOB或TEXT)的查询性能。就是为大文本字段内容建立一个散列值，并单独存储到一列中，
+ 在不必要的时候避免检索大型的BLOB或TEXT值
+ 把BLOB或TEXT列分离到单独的表中

#### 8.3 浮点数和定点数
浮点数 float, double，插入数据如果精度超过定义精度，自动四舍五入
定点数 decimal,实际以字符串形式存放

在精度要求较高的应用中，使用定点数而不是浮点数，因为浮点数会有精度的误差。

#### 8.4 日期类型选择
DATE, TIME, DATETIME, TIMESTAMP
如果要记录年份较久远，最好使用DATETIME，因为TIMESTAMP表示的日期范围要短
如果记录的日期要让不同时区的用户使用，最好使用TIMESTAMP, 只有它能和实际时区对应


### 第9章 字符集

#### 9.4 选择合适的字符集
+ 满足应用支持语言的需求，如果需要处理各种文字，或者发布到不用语言的地区，选择UTF-8
+ 如果应用中涉及已有数据的导入，需要考虑字符集对已有数据的兼容性。比如已有数据是GBK文字，如果选择GB2312-80位字符集，那么久会出现某些文字无法导入
+ 如果数据库只需要支持一般中文，且数据量大，性能要求高，那么就可以选择双字节定长编码的GBK，这样比UTF-8的汉字编码要少1个字节（GBK汉字2个字节，UTF8汉字3个字节）
+ 如果需要做大量的字符运算，比如比较、排序等，那么优先选择定长字符集，处理速度更快
+ 如果客户端程序都支持相同的字符集，那么优先选择该字符集避免因为字符集转换带来的开销和数据损失

#### 9.5 MySQL支持的字符集
MYSQL字符集包括字符集(CHARACTER)和校对规则(COLLATION)2个概念。
其中字符集用来定义MYSQL存储字符串的方式，校对规则用来定义比较字符串的方式。

每个字符集至少对应1个校对规则。校对规则命名约定：
相关字符集名 + 语言名 + _ci(大小写不敏感) | _cs(大小写敏感) | _bin(基于字符串编码值比较)


### 第10章 索引的设计和使用

#### 10.1 索引概述
每种存储引擎对每个表支持至少16个索引，总索引长度至少为256字节。

InnoDB的表默认创建的是BTREE索引，也支持前缀索引，即对索引字段的前N个字符创建索引。InnoDB中，索引前缀长度最长767字节。

#### 10.2 设计索引的原则
+ 搜索的索引列，不一定是所要选择的列。也就是说最合适索引的列式出现在WHERE子句中的列，或链接字句中的列，而不是出现在SELECT关键字后的选择列表中的列
+ 使用唯一索引，考虑值的分布，索引的列的基数越大，索引效果就越好。
+ 使用短索引，如果对字符串列进行索引，指定一个前缀长度，比如一个CHAR(200)的列，前缀取10~20个字符即可
+ 利用最左前缀，在创建一个n列的索引时，实际上是创建了MYSQL可利用的n个索引，多列索引可起几个索引的作用，利用索引中最左边的列集来匹配行
+ 不要过度索引，每个额外的索引都要占用额外的磁盘空间，降低写性能。MYSQL在生成一个执行计划时，会对索引进行考虑，如果索引需要花费工作太多，可能就选择不到最好的索引。
+ 对于InnoDB的表，记录默认按照一定顺序保存，如果有明确的主键，按照主键顺序保存，如果没有主键，但是有唯一索引，那么按照唯一索引顺序保存，否则，表中会自动生成一个内部列，按照这个列的顺序保存。
按照主键或者内部列的访问时最快的，所以InnoDB尽量自己指定主键，提高查询效率。另外，InnoDB的普通索引都会保存主键的键值，因此，主键需要尽可能短的数据类型，减少索引的磁盘占用，
提高索引缓存效果

#### BTREE索引与HASH索引
HASH索引一些特征如下：
+ 只用于 = 或 <=> 操作符的等式比较
+ 优化器不能使用HASH索引来加速ORDER BY操作
+ MYSQL不能确定两个值之间的行数，如果将一个MYISAM表改为HASH索引的MEMORY表，会影响查询效率
+ 只能使用整个关键字来搜索一行

而BTREE索引，使用>, <, >=, <=, BETWEEMN, !=或者<>, LIKE `pattern`时(pattern不是通配符开头)，都可以使用相关列上的索引


### 第14章 事务控制和锁定语句

MYSQL支持对InnoDB的表进行行级锁定


#### 14.3 分布式事务的使用
分布式事务只支持InnoDB

##### 14.3.1 分布式事务的原理
在MYSQL中，分布式事务设计一个或多个资源管理器，以及一个事务管理器
+ 资源管理器(RM)，用于提供通向事务资源的途径，数据库服务器就是一种资源管理器，该管理器必须可以提交或者回滚由资源管理器管理的事务，
比如多台MYSQL数据库作为多台资源管理器
+ 事务管理器(TM)，用于协调作为一个分布式事务一部分的事务。事务管理器与管理每个事务的资源管理器进行通信。在一个分布式事务中，
各个单个事务都是分布式事务的分支事务。

MYSQL执行XA MYSQL时，MYSQL服务器相当于一个用于管理分布式事务中的XA事务的资源管理器，与MYSQL连接的客户端相当于事务管理器

要执行一个分布式事务，必须要知道这个事务涉及了哪些资源管理器，并且把每个资源管理器的事务执行到事务被提交或者回滚。

用于执行分布式事务的过程使用`两阶段提交`，发生时间在由分布式事务的各个分支需要进行的行动已经被执行后
+ 第一阶段，所有分支被预备好，即它们被TM告知要准备提交。意味着用于管理分支的每个RM会记录对于被稳定保存的分支的行动，分支指示是否它们可以这么做，
结果被用于第二阶段
+ 第二阶段，TM告知RMs是否要提交或回滚，如果在预备分支时，所有分支指示它们能够提交，则所有的分支被告知要提交。
如果在预备时，有任何分支指示不能提交，则所有分支被告知回滚


### 第17章 MySQL分区
根据一定规则，将一个表分解成多个更小的，容易管理的部分，对业务逻辑透明。

分区的优点：
+ 存储更多数据
+ 优化查询，在WHERE子句中包含分区条件时，可以只扫描必要的一个或多个分区来提高查询效率；同时在涉及SUM和COUNT聚合函数的查询时，可以容易的在分区上并行
+ 对于已经过期或者不需要保存的数据，可以通过删除与这些数据有关的分区来快速删除
+ 跨多个磁盘来分散数查询，获取更大查询吞吐量

使用ENGINE子句来设置分区。
```
ENGINE=INNODB
PARTITION BY HASH(MONTH(birth_date))
PARTITION 6
```

#### 17.2 分区类型
+ RANGE分区：基于一个给定的连续区间范围，将数据分配到不同分区
+ LIST分区：类似RANGE分区，区别是LIST分区是基于枚举值，RANGE分区基于范围值
+ HASH分区：基于给定的分区个数，哈希到不同分区
+ KEY分区：类似HASH分区

无论哪种分区类型，要么分区表上没有主键/唯一键，要么分区表的主键/唯一键必须包含分区键，
也就是说不能使用主键/唯一键字段之外的其他字段分区

Columns分区支持了多种类型：
+ 所有整数类型
+ 日期时间类型, data和dtetime
+ 字符类型，不支持text和blob


### 第18章 SQL优化
// @todo: 2019-06-06


