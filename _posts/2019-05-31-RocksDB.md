## RocksDB

### 基本操作

#### 打开数据库
一个rocksdb数据库名称对应一个文件系统里的目录，所有这个数据库里的内容都会存到这个目录下。

#### RocksDB Options
一些Option可以在运行的时候修改，比如`write_buffer_size`， `max_background_flushes`等。
RocksDB会自动将这些皮遏制保存在数据库的`OPTIONS-XXX`文件中。

#### Status

#### 关闭数据库
直接删除db对象

#### 读写
rocksDB提供了`Put`，`Delete`和`Get`方法来修改、查询数据库。
每一个Get的返回结果都至少会有1次将源数据赋值到目标字符串的内存拷贝，如果源数据在缓存的block中，可以使用`PinnableSlice`来避免额外的拷贝开销

#### 原子更新
可以使用`WriteBatch`类来将一些列的更新操作转换成原子操作。

#### 同步写
默认情况下，rocksDB的写是异步的：在将进程里的写入内容推送到OS后就立即返回了。而那些从OS内存到底层持久化存储的转换过程都是异步的发生的。
可以设置`sync`标志位来设置写操作为同步

#### 非同步写
在非同步写模式下，rocksDB仅仅会buffer WAL(前置写日志)在OS的内如或者内部buffer，这种方式比同步写要快很多，但是会造成机器crash时有丢失部分最新更新操作的可能。

要注意的是，即使sync设置为false时，写操作进程的crash并不会丢失任何数据，因为在将一个更新操作完成之前，会先从进程内存推送到OS。

非同步写也可以很安全的被使用。比如加载一组庞大的数据到数据库。

也可以通过设置`write_option.disableWAL`为`true`来完全的禁止掉Write Ahead Log, 这样写入就不会进入log，进程crash的时候可能会丢失数据

#### 并行
一个数据库同一时间只允许被一个进程打开。在单个进程内，`rocksdb::DB`是可以被多个并发的线程共享的。

#### Merge操作
merge操作用来高效的支持`read-modify-write`的操作

#### 迭代

#### 快照
快照为所有key-value存储提供了一种一致的只读视图。`ReadOption::snapshot`设置为非NULL用来表示一个读操作必须在特定的版本上进行，否则会在当前状态的直接快照上操作。

当快照不使用时，记得调用`DB::ReleaseSnapshot`来释放掉

#### 切片
一个切片是一个包含一个长度和一个指向外部字节数组指针的结构。这样将切片用作返回就可以避免赋值大的key-value对。

#### 事务
rocksDB支持多操作的事务

#### 比较器
默认按照字典序对key进行排序，也客户自指定自己的比较器。

#### 列族
列族为数据库提供了一种逻辑上的划分。可以在不同的列族上提供多key的原子写操作以及一致性的只读视图

#### 块加载

#### 备份和检查点
rocksDB允许用户定期的将增量备份到外部文件系统，比如HDFS、S3等；
检查点提供了为一个运行中的数据库在一个单独的目录创建快照的功能。

#### I/O
默认情况下，rocksDB的IO通过操作系统的页缓存。也可以采用跳过页缓存，直接IO、

#### 向后兼容

#### MemTable和Table factories
默认情况下，内存中数据用跳跃表实现memtable, 在磁盘上的是根据用的是RocksDB Table Format.
RocksDB还支持memtable和table格式的不同实现。

#### 性能

#### 块大小
rocksDB将相邻的key组合进同一个block，作为转换到持久化操作的基本单元。默认块大小是4096字节。
大的块适合用于做批量的扫描数据库内容，小的块适合于大量的小value的点查询。

#### 写缓冲
写缓冲的大小表明了数据在写入磁盘之前在内存中可以贮存的数据量，
默认有2个写缓冲，因此当1个缓冲满而需要刷到磁盘时，新的写入并不会阻塞；

#### 压缩
每个block在写入持久化存储之前，都会被单独的压缩。默认压缩是开启的。

#### 缓存
数据库中的数据是存储在一个文件系统中的一组文件中，每个文件存储这一系列的压缩blocks, 如果`options.block_cache`是非NULL，
它将会定期的用未压缩的块内容来缓存。可以通过设置`options.no_block_cache`来禁用block缓存

#### Key Layout
考虑到磁盘转移和缓存的单位是一个block, 相邻的key往往会被放在相同的block里，因此，应用程序可以通过将可以互相访问的key放在一起，
并且将不常用的key放在一个单独的区域中，来提高性能

#### 过滤器
考虑到rocksDB在磁盘上组织数据的方式，一个简单的Get请求可能会涉及到磁盘上的多次读取。
可以设置`FilterPolicy`机制可以减少磁盘读取的次数。

比如，通过给数据库关联上一个布隆过滤器的filter policy，一般可以将不必要的磁盘读取减小大约100倍。
对于一些需要大量随机读或者不适合内存存储的工作，建议使用过滤器机制。

#### 校验和
+ ReadOptins::verify_checksums强制的为所有从文件系统读取的数据校验和
+ Options::paranoid_checks可以设置为true，然后打开数据库，可以用于快速检测内部错误。基于错误的不同，可能是打开时，也可能是稍后的一个数据库操作。
默认情况下，paranoid检查是关闭的，因此就算持久化存储损坏了，数据库也依然可以用。

#### Compaction
rocksDB会持续的重写现有的数据文件，删除过期版本的key，保持数据结构便于读取。

#### Approximate Sizes

#### Environment
所有的rocksDB实现的文件操作都是通过一个`rocksdb::ENV`对象引入的

// todo

