---
layout: post
title: 区块链技术指南学习笔记
date: 2018-07-03 15:50:00.000000000 +09:00
---

### 5.2.3 非对称加密
很好解决了对称加密需要提前分发密钥的问题。
加密密钥和解密密钥是不同的，分别称为公钥和私钥，公钥一般是公开的，私钥一般私人持有

缺点是加解密速度较慢，一般比对称加密算法慢2~3个数量级。代表算法有：RSA、椭圆曲线系列算法。
其中椭圆曲线算法基于对椭圆曲线上特定点进行特殊乘法逆运算难以计算的特性，一般适用于签名场景或者密钥协商，不适用于大量数据的加解密

#### 6.2.1.3 脚本
脚本是保障交易完成的核心机制。
一般每个交易都会包括两个脚本：输出脚本（锁定脚本）和认领脚本（解锁脚本）
+ 输出脚本（锁定脚本）：一般由付款方对交易设置锁定，用来对能动用这笔交易输出的对象进行权限控制，例如限制必须是某个公钥的拥有者才能花费这笔交易
+ 认领脚本（解锁脚本）：用来证明自己可以满足交易输出脚本的锁定条件

输出脚本目前支持两种类型：
+ P2PKH：允许用户将比特币发送到一个或多个典型的比特币地址上，前导字节一般为0x00
+ P2SH：支付者创建一个输出脚本，里面包含另一个认领脚本的哈希，一般用于需要多人签名的场景，前导字节一般为0x05

以P2PKH为例，输出脚本格式为
```
scriptPubKey：OP_DUP OP_HASH160 <pubKeyHash> OP_EQUALVERIFY OP_CHECKSIG
```

另一个交易如果要花费这个输出，在引用这个输出的时候，需要提供认领脚本：
```
scriptSig: <sig><pubKey>
```

输入的解锁脚本和输出的锁定脚本会在交易发生时执行，当栈顶最后剩一个TRUE时，表明交易合法，否则非法。


## 七、以太坊
---
以太坊提供了一条公开的区块链，并制定了面向智能合约的一套编程语言，智能合约开发者可以在其实使用官方提供的工具来开发支持以太坊区块链协议的应用，即DAPP。
这些应用将运行在以太坊的虚拟机EVM里，用户通过以太币来购买燃料，维持所部署应用的运行。

以太坊进一步扩展了区块链网络的能力，从交易延伸为智能合约。特点主要包括：
+ 单独为智能合约指定编程语言Solidity
+ 使用了内存需求较高的哈希函数，避免出现算力矿机
+ uncle块激励机制：降低矿池的优势，减少区块产生间隔为15秒
+ 采用账户系统和世界状态，而不是UTXO，容易支持更复杂的逻辑
+ gas限制调整算法：限制代码执行指令数，避免循环共计
+ 记录当前状态的哈希树的根哈希值到区块：某些情况下时下轻量级客户端
+ 为执行智能合约而设计的简化的虚拟机EVM
+ 支持PoW共识算法，并计划支持效率更高的Pos算法

官方提供钱包客户端Mist，支持进行交易，同时支持直接编写和部署智能合约。
所编写的代码编译发布后，可以部署到区块链上。使用者可以通过发送调用相应合约方法的交易，由矿工的以太坊虚拟机EVM在区块链上执行

### 7.4 协议设计
核心概念：
+ 智能合约：即以计算机程序的方式来缔结和运行各种合约。以太坊支持通过图灵完备的高级语言（Solidity等）来开发智能合约。智能合约作为运行在以太坊虚拟机中的应用，可以接受来自外部的交易请求和事件。
通过触发提前编写好的代码逻辑，进一步生成新的交易和事件。

+ 账户：比特币中没有账户的概念，而是采用了UTXO模型记录整个系统的状态。以太坊不同，直接用账户来记录系统状态，每个账户存储余额信息、智能合约代码和内部数据存储等。
具体来看，以太坊账户分为两种账户：合约账户，存储执行的合约代码，只能被外部账户来调用激活；外部账户，以太币拥有者账户，对应到某公钥，账户包括nonce、balance、storageRoot、codeHash等字段，由个人控制

+ 交易：指从一个账户到另一个账户的消息数据。消息数据可以是以太币或者合约执行参数
每个交易包括以下字段：
1. to: 目标账户地址
2. value: 可以指定转移的以太币数量
3. nonce：交易相关的字串，用于防止交易被重放
4. gasPrice: 执行交易需要消耗的Gas价格
5. startGas: 交易消耗的最大Gas值
6. signature: 签名信息

+ 以太币
以太币主要用于购买燃料，支付给矿工，以维护以太坊网络运行智能合约的费用。
同样也可以通过挖矿生成，成功生成新区块的矿工可以获得5个以太币的奖励，以及包含在区块内的燃料费用。

+ 燃料
控制某次交易执行指令的上限，每执行一台合约指令会消耗固定的然燃料，如果某个交易还未执行结束，燃料就已消耗完，合约执行终止并回滚状态


以太坊目前采用了基于成熟的PoW共识的变种算法Ethash协议作为共识机制。为防止ASIC矿机的算力攻击，与原始PoW不用，Ethash在执行时需要消耗大量内存，反而根计算效率关系不大。这意味着通用机器可能更加有效。
然而Ethash的运算也都是无效的，未来计划采用更高效的Pos（Proof-of-Stake）作为共识机制

geth控制台（Javascript执行环境）
+ eth：包含一些跟操作区块链相关的方法
+ net：包含以下查看p2p网络状态的方法
+ admin：包含一些与管理节点相关的方法
+ miner：包含启动&停止挖矿的一些方法
+ personal：主要包含一些管理账户的方法
+ txpool：包含一些查看交易内存池的方法
+ web3：包含了以上对象，还包含一些单位换算的方法

启动区块链：
```
$ geth --identity "TestNode" --rpc --rpcport "8545" --datadir /path/to/datadir --port "30303" --nodiscover console
$ geth --identity "TestNode" --rpc --nodiscover console
```

挖矿：
```
// 开始
miner.start()
// 停止
miner.stop()
```

#### 创建和编译智能合约
以太坊使用Solidity编写智能合约，首先需要安装solc编译器
创建一个Solidity智能合约文件，命名为testContract.sol
```solidity
pragma solidity ^0.4.0;
contract testContract {
    function multiply(uint a) returns(unit d) {
        d = a * 7;
    }
}
```

用solc获得编译后的EVM二进制码：
```
$ solc --bin testContract.sol

======= testContract.sol:testContract =======
Binary: 
608060405234801561001057600080fd5b5060bb8061001f6000396000f300608060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063c6888fa1146044575b600080fd5b348015604f57600080fd5b50606c600480360381019080803590602001909291905050506082565b6040518082815260200191505060405180910390f35b60006007820290509190505600a165627a7a72305820a08ea118a0375ba65d5ab49e312ef3ff8938632fbcaba847de686977e3d982620029
```

再用solc获得合约的JSON ABI(Application Binary Interface)，其中提供了合约接口，包括可调用的合约方法、变量、事件等
```
$ solc --abi testContract.sol

======= testContract.sol:testContract =======
Contract JSON ABI 
[{"constant":false,"inputs":[{"name":"a","type":"uint256"}],"name":"multiply","outputs":[{"name":"d","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"}]
```

接下来，回到Geth的JS环境运行界面，用变量记录上面的两个值
```js
code = "0x608060405234801561001057600080fd5b5060bb8061001f6000396000f300608060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063c6888fa1146044575b600080fd5b348015604f57600080fd5b50606c600480360381019080803590602001909291905050506082565b6040518082815260200191505060405180910390f35b60006007820290509190505600a165627a7a72305820a08ea118a0375ba65d5ab49e312ef3ff8938632fbcaba847de686977e3d982620029"
abi = [{"constant":false,"inputs":[{"name":"a","type":"uint256"}],"name":"multiply","outputs":[{"name":"d","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"}]
```

#### 部署智能合约

```js
// 先解锁自己的账户
personal.unlockAccount(myAddress)
// 发送部署合约的交易
myContract = eth.contract(abi)
contract = myContract.new({from:myAddress,data:code,gas:1000000})
```

如果此时没有矿机在挖矿，用``txpool.status``可与看到本地交易池中有一个待确认的交易，可用以下命令看到当前待确认的交易
```js
eth.getBlock("pending", true).transactions
[{
    blockHash: "0xf3b152ac5e9f61b0f21a6b721314dce6640526cd37ef0784f3e9dfe2cb859760",
    blockNumber: 24,
    from: "0x4c8a2c6c77471a61e01c1e2dfd9b643b6695d682",
    gas: 1000000,
    gasPrice: 18000000000,
    hash: "0x8ba212e5ba2147721ece32a9e5b4d162172c753b4b37e6bb8338df6863dee82b",
    input: "0x608060405234801561001057600080fd5b5060bb8061001f6000396000f300608060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063c6888fa1146044575b600080fd5b348015604f57600080fd5b50606c600480360381019080803590602001909291905050506082565b6040518082815260200191505060405180910390f35b60006007820290509190505600a165627a7a72305820a08ea118a0375ba65d5ab49e312ef3ff8938632fbcaba847de686977e3d982620029",
    nonce: 0,
    r: "0xc6e111a5c58813c25f440706ce75ec01f5d5d4bec5725431492ff5165a0dd3c7",
    s: "0x33abb5fb7f2dd093edf21307785bd91e0ab61a5726cd01ff504c6cca92af1895",
    to: null,
    transactionIndex: 0,
    v: "0x42",
    value: 0
}]
```

可用用``miner.start()``开始挖矿，一段时间后，交易会被确认，随即新区块会进入区块链


#### 调用智能合约
用以下命令可用发送交易，其中``sendTransaction``方法的前几个参数与合约中multiply方法的输入参数对应
```js
contract.multiply.sendTransaction(10, {from:myAddress})
```


### 智能合约案例：投票
该智能合约实现了一个自动化的、透明的投票应用。

#### 代码解析
指定版本：
```js
// 支持版本0.4.11 <= version < 0.5.0
pragma solidity ^0.4.11;
```

结构体类型：
Solidity中的合约类似于面向对象中的类。每个合约可以包含状态变量、函数、事件、结构体类型和枚举类型等，一个合约也可以继承另一个合约

``address``类型记录了一个以太坊账户的地址，``address``可以看做一个数值类型，但也包括一些以太币相关的方法，如查询余额``<address>.balance``、向该地址转账``<address>.transfer(uint256 amount)``等

#### 状态变量
合约中的状态变量会长期保存在区块链中，通过调用合约里的函数，这些状态变量可以被读取和改写。
状态变量可以设置为public、internal或者private。internal只能被合约和继承合约的子合约访问，private仅能被合约访问，public可以被外部访问，默认为internal。

#### 函数
``msg.sender``可以获得当前调用消息的发送者地址。

以太坊项目将区块链技术在数字火币的基础上进行了延伸，提出打造更为通用的智能合约平台的宏大构想。


八、超级账本（Hyperledger）- 商用分布式账本
---
实现了完备的权限控制、创新的一致性算法和可拔插、可扩展的框架。为区块链技术的开源规范和标准，让更多的应用能够更容易的建立在区块链技术之上。
目前主要包括三大账本平台和若干其他项目
账本平台项目：
+ Fabric
+ SawToothLake
+ Iroha
其他项目：
+ Blockchain Explorer
+ Cello

目前项目均在孵化中





